var P=Object.defineProperty;var j=(n,e,t)=>e in n?P(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var l=(n,e,t)=>(j(n,typeof e!="symbol"?e+"":e,t),t),_=(n,e,t)=>{if(!e.has(n))throw TypeError("Cannot "+t)};var i=(n,e,t)=>(_(n,e,"read from private field"),t?t.call(n):e.get(n)),k=(n,e,t)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,t)},h=(n,e,t,r)=>(_(n,e,"write to private field"),r?r.call(n,t):e.set(n,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))r(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const a of o.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&r(a)}).observe(document,{childList:!0,subtree:!0});function t(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(s){if(s.ep)return;s.ep=!0;const o=t(s);fetch(s.href,o)}})();var g,f,T,S;class B{constructor({taskID:e=null,text:t,position:r,index:s}){k(this,g,"");k(this,f,"");k(this,T,-1);k(this,S,-1);h(this,g,e||crypto.randomUUID()),h(this,f,t),h(this,T,r),h(this,S,s)}get taskID(){return i(this,g)}get taskText(){return i(this,f)}set taskText(e){typeof e=="string"&&h(this,f,e)}get taskIndex(){return i(this,S)}set taskIndex(e){typeof e=="string"&&h(this,S,e)}get taskPosition(){return i(this,T)}set taskPosition(e){typeof e=="number"&&e>=0&&h(this,T,e)}render(){const e=document.createElement("li");e.classList.add("courier__tasks-list-item","task"),e.setAttribute("id",i(this,g)),e.setAttribute("draggable",!0),e.addEventListener("dragstart",a=>{a.target.classList.add("task_selected"),localStorage.setItem("movedTaskID",i(this,g))}),e.addEventListener("dragend",a=>a.target.classList.remove("task_selected"));const t=document.createElement("span");t.classList.add("task__text"),t.innerHTML=i(this,f),e.appendChild(t);const r=document.createElement("div");r.classList.add("task__controls");const s=document.createElement("div");s.classList.add("task__controls-row");const o=document.createElement("button");return o.setAttribute("type","button"),o.classList.add("task__contol-btn","delete-icon"),o.addEventListener("click",()=>{localStorage.setItem("deleteTaskID",i(this,g));const a=document.getElementById("modal-delete-task");a.querySelector(".app-modal__question").innerHTML=`Остановка '${i(this,f)}' будет удалена. Прододлжить?`,a.showModal()}),s.appendChild(o),r.appendChild(s),e.appendChild(r),e}}g=new WeakMap,f=new WeakMap,T=new WeakMap,S=new WeakMap;class y{static async getCouriers(){try{const e=await fetch("http://localhost:8080/couriers"),t=await e.json();return e.status!==200?Promise.reject(t):t.couriers}catch(e){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:e.message})}}static async addCourier({courierID:e,name:t}){try{const r=await fetch("http://localhost:8080/couriers",{method:"POST",body:JSON.stringify({courierID:e,name:t}),headers:{"Content-type":"application/json"}});if(r.status!==200){const s=await r.json();return Promise.reject(s)}return{timestamp:new Date().toISOString(),message:`Маршрут ${t} был успешно добавлен`}}catch(r){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:r.message})}}static async addTask({taskID:e,text:t,position:r,index:s,courierID:o}){try{const a=await fetch("http://localhost:8080/tasks",{method:"POST",body:JSON.stringify({taskID:e,text:t,position:r,index:s,courierID:o}),headers:{"Content-type":"application/json"}});if(a.status!==200){const c=await a.json();return Promise.reject(c)}return{timestamp:new Date().toISOString(),message:`Остановка ${t} была успешно добавлена`}}catch(a){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:a.message})}}static async updateCourier({courierID:e,name:t}){try{const r=await fetch(`http://localhost:8080/couriers/${e}`,{method:"PATCH",body:JSON.stringify({name:t}),headers:{"Content-type":"application/json"}});if(r.status!==200){const s=await r.json();return Promise.reject(s)}return{timestamp:new Date().toISOString(),message:`Маршрут ${t} был успешно изменен`}}catch(r){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:r.message})}}static async updateTask({taskID:e,text:t,position:r}){try{const s=await fetch(`http://localhost:8080/tasks/${e}`,{method:"PATCH",body:JSON.stringify({text:t}),headers:{"Content-type":"application/json"}});if(s.status!==200){const o=await s.json();return Promise.reject(o)}return{timestamp:new Date().toISOString(),message:`Остановка ${t} была успешна изменена`}}catch(s){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:s.message})}}static async updateTasks({reorderedTasks:e=[]}={reorderedTasks:[]}){try{const t=await fetch("http://localhost:8080/tasks",{method:"PATCH",body:JSON.stringify({reorderedTasks:e}),headers:{"Content-type":"application/json"}});if(t.status!==200){const r=await t.json();return Promise.reject(r)}return{timestamp:new Date().toISOString(),message:"Порядок остановок был успешно изменен"}}catch(t){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:t.message})}}static async deleteTask({taskID:e}){try{const t=await fetch(`http://localhost:8080/tasks/${e}`,{method:"DELETE"});if(t.status!==200){const r=await t.json();return Promise.reject(r)}return{timestamp:new Date().toISOString(),message:`Остановка ${e} была успешна удалена`}}catch(t){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:t.message})}}static async moveTask({taskID:e,srcCourierID:t,destCourierID:r}){try{const s=await fetch("http://localhost:8080/couriers",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({taskID:e,srcCourierID:t,destCourierID:r})});if(s.status!==200){const o=await s.json();return Promise.reject(o)}return{timestamp:new Date().toISOString(),message:`Задание ${e} было успешна перемещена`}}catch(s){return Promise.reject({timestamp:new Date().toISOString(),statusCode:0,message:s.message})}}}function O(n){this.message=n,this.name="Исключение, определённое пользователем"}var u,I,m;class b{constructor({courierID:e=null,name:t,onDropTaskInCourier:r,addNotification:s}){k(this,u,[]);k(this,I,"");k(this,m,"");l(this,"pushTask",({task:e})=>i(this,u).push(e));l(this,"getTaskById",({taskID:e})=>i(this,u).find(t=>t.taskID===e));l(this,"deleteTask",({taskID:e})=>{const t=i(this,u).findIndex(s=>s.taskID===e);if(t===-1)return;const[r]=i(this,u).splice(t,1);return r});l(this,"reorderTasks",async()=>{const e=Array.from(document.querySelector(`[id="${i(this,m)}"] .courier__tasks-list`).children,r=>r.getAttribute("id")),t=[];try{if(e.forEach((r,s)=>{const o=i(this,u).find(a=>a.taskID===r);o.taskPosition!=s&&(o.taskPosition=s,t.push({taskID:r,position:s}))}),t.length>0)try{await y.updateTasks({reorderedTasks:t})}catch(r){this.addNotification({text:r.message,type:"error"}),console.error(r)}}catch{throw new O("Error")}});l(this,"appendNewTask",async({text:e,position:t,index:r})=>{try{const s=crypto.randomUUID(),o=await y.addTask({taskID:s,text:e,position:t,index:r,courierID:i(this,m)});this.addNewTaskLocal({taskID:s,text:e,position:i(this,u).length,index:r}),this.addNotification({text:o.message,type:"success"})}catch(s){this.addNotification({text:s.message,type:"error"}),console.error(s)}});l(this,"addNewTaskLocal",({taskID:e=null,text:t,position:r,index:s})=>{const o=new B({taskID:e,text:t,position:r,index:s});i(this,u).push(o);const a=o.render();document.querySelector(`[id="${i(this,m)}"] .courier__tasks-list`).appendChild(a)});h(this,I,t),h(this,m,e||crypto.randomUUID()),this.onDropTaskInCourier=r,this.addNotification=s}get courierID(){return i(this,m)}get name(){return i(this,I)}set name(e){typeof e=="string"&&h(this,I,e)}get tasks(){return i(this,u)}render(){const e=document.createElement("li");e.classList.add("couriers-list__item","courier"),e.setAttribute("id",i(this,m)),e.addEventListener("dragstart",()=>localStorage.setItem("srcCourierID",i(this,m))),e.addEventListener("drop",this.onDropTaskInCourier);const t=document.createElement("div");t.classList.add("courier-list__item-header");const r=document.createElement("span");r.classList.add("courier__name"),r.innerHTML=i(this,I),t.appendChild(r);const s=document.createElement("button");s.setAttribute("type","button"),s.classList.add("courier__edit-btn","edit-icon"),s.addEventListener("click",()=>{localStorage.setItem("editCourierID",i(this,m)),localStorage.setItem("tasksLength",i(this,u).length),document.getElementById("modal-edit-courier").showModal()}),t.appendChild(s),e.appendChild(t);const o=document.createElement("ul");o.classList.add("courier__tasks-list"),e.appendChild(o);const a=document.createElement("button");a.setAttribute("type","button"),a.classList.add("courier__add-task-btn"),a.innerHTML="&#10010; Добавить остановку",a.addEventListener("click",()=>{localStorage.setItem("addTaskCourierID",i(this,m)),document.getElementById("modal-add-task").showModal()}),e.appendChild(a);const c=document.querySelector(".courier-adder");c.parentElement.insertBefore(e,c)}}u=new WeakMap,I=new WeakMap,m=new WeakMap;var p,E;class q{constructor(){k(this,p,[]);k(this,E,["1 остановка","2 остановка","3 остановка","4 остановка"]);l(this,"onEscapeKeydown",e=>{if(e.key==="Escape"){const t=document.querySelector(".courier-adder__input");t.style.display="none",t.value="",document.querySelector(".courier-adder__btn").style.display="inherit"}});l(this,"onDropTaskInCourier",async e=>{e.stopPropagation();const t=e.currentTarget;t.classList.remove("courier_droppable");const r=localStorage.getItem("movedTaskID"),s=localStorage.getItem("srcCourierID"),o=t.getAttribute("id");if(localStorage.setItem("movedTaskID",""),localStorage.setItem("srcCourierID",""),!t.querySelector(`[id="${r}"]`))return;const a=i(this,p).find(d=>d.courierID===s),c=i(this,p).find(d=>d.courierID===o),v=a.getTaskById({taskID:r});let C=!1,L=0;for(let d of c.tasks)if(d.index===v.index){L+=1;break}L>2&&(C=!0);const N=Array.from(document.querySelector(`[id="${o}"] .courier__tasks-list`).children,d=>d.getAttribute("id"));let w=-1;if(N.forEach((d,M)=>{let D=c.tasks.find(x=>x.taskID===d);D||(D=v),w>=D.taskIndex&&(C=!0),w=D.taskIndex,console.log(w)}),console.log(C),C)alert("Нельзя переместить остановку в данное место"),location.reload(),this.addNotification({text:"Нельзя переместить остановку в данное место",type:"error"});else try{if(s!==o){await y.moveTask({taskID:r,srcCourierID:s,destCourierID:o});const d=a.deleteTask({taskID:r});c.pushTask({task:d}),a.reorderTasks()}c.reorderTasks(),this.addNotification({text:`Остановка ${r} перемещена между маршрутами`,type:"success"})}catch(d){this.addNotification({text:d.message,type:"error"}),console.error(d)}});l(this,"editCourier",async({courierID:e,newName:t})=>{let r=null;r=i(this,p).find(o=>o.courierID===e);const s=r.name;if(!(!s||t===s))try{const o=await y.updateCourier({courierID:e,name:t});r.name=t,document.querySelector(`[id="${e}"] span.courier__name`).innerHTML=t}catch(o){this.addNotification({text:o.message,type:"error"}),console.error(o)}});l(this,"deleteTask",async({taskID:e})=>{let t=null,r=null;for(let s of i(this,p))if(r=s,t=s.getTaskById({taskID:e}),t)break;try{const s=await y.deleteTask({taskID:e});r.deleteTask({taskID:e}),document.getElementById(e).remove(),this.addNotification({text:s.message,type:"success"})}catch(s){this.addNotification({text:s.message,type:"error"}),console.error(s)}});l(this,"addNotification",({text:e,type:t})=>{const r=document.getElementById("app-notifications"),s=crypto.randomUUID(),o=document.createElement("div");o.classList.add("notification",t==="success"?"notification-success":"notification-error"),o.setAttribute("id",s),o.innerHTML=e,r.appendChild(o),setTimeout(()=>{document.getElementById(s).remove()},5e3)})}initAddCourierModal(){const e=document.getElementById("modal-add-courier"),t=()=>{e.close(),e.querySelector(".app-modal__input").value=""},r=async()=>{const s=crypto.randomUUID(),o=document.getElementById("modal-add-courier-input");if(o.value)try{const a=await y.addCourier({courierID:s,name:o.value}),c=new b({courierID:s,name:o.value,onDropTaskInCourier:this.onDropTaskInCourier,addNotification:this.addNotification});i(this,p).push(c),c.render(),this.addNotification({text:a.message,type:"success"})}catch(a){this.addNotification({text:a.message,type:"error"}),console.error(a)}t()};e.querySelector(".modal-ok-btn").addEventListener("click",r),e.querySelector(".modal-cancel-btn").addEventListener("click",t),e.addEventListener("close",t)}initAddTaskModal(){const e=document.getElementById("modal-add-task"),t=()=>{e.close(),localStorage.setItem("addTaskCourierID","")},r=()=>{const s=localStorage.getItem("addTaskCourierID"),o=document.getElementById("modal-add-task-selector"),a=i(this,p).find(c=>c.courierID===s);console.log(a.tasks),a.tasks.length>0?a.tasks[a.tasks.length-1].taskIndex<o.value+1||a.tasks[0].taskIndex==o.value?i(this,p).find(c=>c.courierID===s).appendNewTask({text:String(i(this,E)[o.value-1]),position:a.tasks.length+1,index:o.value}):this.addNotification({text:"Невозможно добавить остановку"}):i(this,p).find(c=>c.courierID===s).appendNewTask({text:String(i(this,E)[o.value-1]),position:a.tasks.length+1,index:o.value}),t()};e.querySelector(".modal-ok-btn").addEventListener("click",r),e.querySelector(".modal-cancel-btn").addEventListener("click",t),e.addEventListener("close",t)}initEditCourierModal(){const e=document.getElementById("modal-edit-courier"),t=()=>{e.close(),localStorage.setItem("editTaskID",""),e.querySelector(".app-modal__input").value=""},r=()=>{const s=localStorage.getItem("editCourierID"),o=document.getElementById("modal-edit-courier-input");s&&o.value&&this.editCourier({courierID:s,newName:o.value}),t()};e.querySelector(".modal-ok-btn").addEventListener("click",r),e.querySelector(".modal-cancel-btn").addEventListener("click",t),e.addEventListener("close",t)}initDeleteTaskModal(){const e=document.getElementById("modal-delete-task"),t=()=>{e.close(),localStorage.setItem("deleteTaskID","")},r=()=>{const s=localStorage.getItem("deleteTaskID");s&&this.deleteTask({taskID:s}),t()};e.querySelector(".modal-ok-btn").addEventListener("click",r),e.querySelector(".modal-cancel-btn").addEventListener("click",t),e.addEventListener("close",t)}initNotifications(){document.getElementById("app-notifications").show()}async init(){document.querySelector(".courier-adder__btn").addEventListener("click",e=>{document.getElementById("modal-add-courier").showModal()}),document.addEventListener("keydown",this.onEscapeKeydown),this.initAddTaskModal(),this.initEditCourierModal(),this.initDeleteTaskModal(),this.initNotifications(),this.initAddCourierModal(),document.addEventListener("dragover",e=>{e.preventDefault();const t=document.querySelector(".task.task_selected"),r=t.closest(".courier"),s=e.target,o=document.querySelector(".courier_droppable");let a=e.target;for(;!a.matches(".courier")&&a!==document.body;)a=a.parentElement;if(a!==o&&(o&&o.classList.remove("courier_droppable"),a.matches(".courier")&&a.classList.add("courier_droppable")),!(!a.matches(".courier")||t===s)){if(a===r){if(!s.matches(".task"))return;const c=s===t.nextElementSibling?s.nextElementSibling:s;a.querySelector(".courier__tasks-list").insertBefore(t,c);return}if(s.matches(".task")){a.querySelector(".courier__tasks-list").insertBefore(t,s);return}a.querySelector(".courier__tasks-list").children.length||a.querySelector(".courier__tasks-list").appendChild(t)}});try{const e=await y.getCouriers();for(const t of e){const r=new b({courierID:t.courierID,name:t.name,onDropTaskInCourier:this.onDropTaskInCourier,addNotification:this.addNotification});i(this,p).push(r),r.render();for(const s of t.tasks)r.addNewTaskLocal({taskID:s.taskID,text:s.text,position:s.position,index:s.ind}),console.log(s.ind)}}catch(e){this.addNotification({text:e.message,type:"error"}),console.error(e)}}}p=new WeakMap,E=new WeakMap;document.addEventListener("DOMContentLoaded",()=>{new q().init()});
